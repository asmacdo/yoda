name: Build PDF and deploy to GitHub Pages

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Only allow one deployment at a time
concurrency:
  group: pages-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install LaTeX and latex-make
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            texlive-latex-base \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-fonts-recommended \
            latex-make \
            poppler-utils \
            diff-pdf \
            xvfb

      - name: Build PDF
        run: make

      - name: Prepare Pages artifact
        run: |
          mkdir -p _site
          cp main.pdf _site/
          cp .github/pages/index.html _site/

      - name: Upload Pages artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Generate PDF diff against main
        if: github.event_name == 'pull_request'
        id: diff
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          REPO: ${{ github.repository }}
          SERVER: ${{ github.server_url }}
        run: |
          PREVIEW_BRANCH="gh-pages-pr-${PR_NUMBER}"
          RAW_BASE="https://raw.githubusercontent.com/${REPO}/${PREVIEW_BRANCH}"
          VIEW_URL="${SERVER}/${REPO}/blob/${PREVIEW_BRANCH}/main.pdf"

          # Start building the comment
          {
            echo "<!-- pdf-preview -->"
            echo "### Paper PDF"
            echo "Built from ${HEAD_SHA}."
            echo "**[View PDF](${VIEW_URL})** | **[Download](${RAW_BASE}/main.pdf)**"
          } > pr-comment.md

          # Try to download the current main PDF for diff
          MAIN_PDF_URL="https://myyoda.github.io/principles-paper/main.pdf"
          if ! curl -sfL "$MAIN_PDF_URL" -o main-base.pdf; then
            echo "" >> pr-comment.md
            echo "*No main PDF deployed yet — diff not available.*" >> pr-comment.md
          else
            # Generate visual diff PDF using diff-pdf (needs virtual display)
            DIFF_VIEW_URL="${SERVER}/${REPO}/blob/${PREVIEW_BRANCH}/diff.pdf"
            if xvfb-run diff-pdf --output-diff=diff.pdf --dpi=300 --channel-tolerance=0 -g \
                 main-base.pdf main.pdf; then
              echo "" >> pr-comment.md
              echo "No visual differences from main." >> pr-comment.md
            else
              # diff-pdf exits non-zero when differences exist
              # Convert diff PDF pages to PNGs for inline preview
              mkdir -p diff-pages
              pdftoppm -png -r 150 diff.pdf diff-pages/page
              pdftoppm -png -r 150 main-base.pdf diff-pages/base
              pdftoppm -png -r 150 main.pdf diff-pages/pr

              mapfile -t DIFF_PNGS < <(ls diff-pages/page-*.png 2>/dev/null | sort -V)
              mapfile -t BASE_PNGS < <(ls diff-pages/base-*.png 2>/dev/null | sort -V)
              mapfile -t PR_PNGS < <(ls diff-pages/pr-*.png 2>/dev/null | sort -V)

              BASE_COUNT=${#BASE_PNGS[@]}
              PR_COUNT=${#PR_PNGS[@]}
              DIFF_COUNT=${#DIFF_PNGS[@]}
              # diff-pdf output covers min(base,pr) pages
              MAX_COUNT=$((BASE_COUNT > PR_COUNT ? BASE_COUNT : PR_COUNT))

              CHANGED=0
              UNCHANGED=0
              ADDED=0
              REMOVED=0
              PAGE_DETAILS=""

              for ((i=0; i<MAX_COUNT; i++)); do
                PAGE_NUM=$((i + 1))
                PADDED=$(printf '%02d' "$PAGE_NUM")

                if [ "$i" -lt "$BASE_COUNT" ] && [ "$i" -lt "$PR_COUNT" ]; then
                  # Check if this page actually differs by comparing the
                  # rendered PNGs (diff-pdf marks changes in red on its output)
                  if [ "$i" -lt "$DIFF_COUNT" ]; then
                    # Compare base vs pr page to see if this specific page changed
                    PIXELS=$(compare -metric AE -fuzz 2% \
                      "${BASE_PNGS[$i]}" "${PR_PNGS[$i]}" /dev/null 2>&1 || true)

                    if [ "$PIXELS" = "0" ] || ! [[ "$PIXELS" =~ ^[0-9]+$ ]]; then
                      UNCHANGED=$((UNCHANGED + 1))
                      PAGE_DETAILS+="- Page ${PAGE_NUM} — unchanged\n"
                    else
                      CHANGED=$((CHANGED + 1))
                      # Rename diff page PNG for upload
                      cp "${DIFF_PNGS[$i]}" "diff-page-${PADDED}.png"
                      DIFF_IMG_URL="${RAW_BASE}/diff-page-${PADDED}.png"
                      PAGE_DETAILS+="<details><summary>Page ${PAGE_NUM} — changed</summary>\n\n"
                      PAGE_DETAILS+="![page ${PAGE_NUM} diff](${DIFF_IMG_URL})\n\n"
                      PAGE_DETAILS+="</details>\n"
                    fi
                  fi
                elif [ "$i" -lt "$PR_COUNT" ]; then
                  ADDED=$((ADDED + 1))
                  PAGE_DETAILS+="- Page ${PAGE_NUM} — **new**\n"
                else
                  REMOVED=$((REMOVED + 1))
                  PAGE_DETAILS+="- Page ${PAGE_NUM} — **removed**\n"
                fi
              done

              # Build summary line
              PARTS=()
              [ "$CHANGED" -gt 0 ]   && PARTS+=("${CHANGED} changed")
              [ "$UNCHANGED" -gt 0 ] && PARTS+=("${UNCHANGED} unchanged")
              [ "$ADDED" -gt 0 ]     && PARTS+=("${ADDED} added")
              [ "$REMOVED" -gt 0 ]   && PARTS+=("${REMOVED} removed")
              SUMMARY="${PR_COUNT} pages total: $(IFS=', '; echo "${PARTS[*]}")"
              [ "$BASE_COUNT" -ne "$PR_COUNT" ] && SUMMARY+=" (was ${BASE_COUNT})"

              {
                echo ""
                echo "#### Diff vs main"
                echo "${SUMMARY}"
                echo "**[View full diff PDF](${DIFF_VIEW_URL})**"
                echo ""
                printf '%b' "$PAGE_DETAILS"
              } >> pr-comment.md
            fi
          fi

          # Set multiline output for the comment step
          {
            echo 'body<<ENDOFCOMMENT'
            cat pr-comment.md
            echo 'ENDOFCOMMENT'
          } >> "$GITHUB_OUTPUT"

      - name: Push PDF and diffs to PR preview branch
        if: github.event_name == 'pull_request'
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          BRANCH="gh-pages-pr-${PR_NUMBER}"
          git checkout --orphan "$BRANCH"
          git rm -rf --cached .
          git add -f main.pdf
          # Add diff PDF and per-page diff images if generated
          [ -f diff.pdf ] && git add -f diff.pdf
          for f in diff-page-*.png; do
            [ -f "$f" ] && git add -f "$f"
          done
          git commit -m "PDF preview for PR #${PR_NUMBER} (${HEAD_SHA:0:7})"
          git push -f origin "$BRANCH"

      - name: Comment on PR with PDF link and diff
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body: ${{ steps.diff.outputs.body }}
          edit-mode: replace

  deploy:
    if: github.ref == 'refs/heads/main'
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
