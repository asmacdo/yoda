name: Build PDF and deploy to GitHub Pages

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Only allow one deployment at a time
concurrency:
  group: pages-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install LaTeX and latex-make
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            texlive-latex-base \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-fonts-recommended \
            latex-make \
            poppler-utils

      - name: Build PDF
        run: make

      - name: Prepare Pages artifact
        run: |
          mkdir -p _site
          cp main.pdf _site/
          cp .github/pages/index.html _site/

      - name: Upload Pages artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-pages-artifact@v3
        with:
          path: _site

      - name: Generate PDF diff against main
        if: github.event_name == 'pull_request'
        id: diff
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
          REPO: ${{ github.repository }}
          SERVER: ${{ github.server_url }}
        run: |
          PREVIEW_BRANCH="gh-pages-pr-${PR_NUMBER}"
          RAW_BASE="https://raw.githubusercontent.com/${REPO}/${PREVIEW_BRANCH}"
          VIEW_URL="${SERVER}/${REPO}/blob/${PREVIEW_BRANCH}/main.pdf"

          # Start building the comment
          {
            echo "<!-- pdf-preview -->"
            echo "### Paper PDF"
            echo "Built from ${HEAD_SHA}."
            echo "**[View PDF](${VIEW_URL})** | **[Download](${RAW_BASE}/main.pdf)**"
          } > pr-comment.md

          # Try to download the current main PDF for diff
          MAIN_PDF_URL="https://myyoda.github.io/principles-paper/main.pdf"
          if ! curl -sfL "$MAIN_PDF_URL" -o main-base.pdf; then
            echo "" >> pr-comment.md
            echo "*No main PDF deployed yet — diff not available.*" >> pr-comment.md
          else
            mkdir -p pages-base pages-pr diff-pages

            pdftoppm -png -r 150 main-base.pdf pages-base/page
            pdftoppm -png -r 150 main.pdf pages-pr/page

            mapfile -t BASE_FILES < <(ls pages-base/*.png 2>/dev/null | sort -V)
            mapfile -t PR_FILES < <(ls pages-pr/*.png 2>/dev/null | sort -V)

            BASE_COUNT=${#BASE_FILES[@]}
            PR_COUNT=${#PR_FILES[@]}
            MAX_COUNT=$((BASE_COUNT > PR_COUNT ? BASE_COUNT : PR_COUNT))

            CHANGED=0
            UNCHANGED=0
            ADDED=0
            REMOVED=0
            PAGE_DETAILS=""

            for ((i=0; i<MAX_COUNT; i++)); do
              PAGE_NUM=$((i + 1))
              PADDED=$(printf '%02d' "$PAGE_NUM")

              if [ "$i" -lt "$BASE_COUNT" ] && [ "$i" -lt "$PR_COUNT" ]; then
                # Page exists in both — compare
                DIFF_FILE="diff-pages/diff-page-${PADDED}.png"
                PIXELS=$(compare -metric AE -fuzz 2% \
                  "${BASE_FILES[$i]}" "${PR_FILES[$i]}" "$DIFF_FILE" 2>&1 || true)

                # compare may output non-numeric on error
                if [ "$PIXELS" = "0" ] || ! [[ "$PIXELS" =~ ^[0-9]+$ ]]; then
                  UNCHANGED=$((UNCHANGED + 1))
                  rm -f "$DIFF_FILE"
                  PAGE_DETAILS+="- Page ${PAGE_NUM} — unchanged\n"
                else
                  CHANGED=$((CHANGED + 1))
                  DIFF_URL="${RAW_BASE}/diff-page-${PADDED}.png"
                  PAGE_DETAILS+="<details><summary>Page ${PAGE_NUM} — ${PIXELS} pixels differ</summary>\n\n"
                  PAGE_DETAILS+="![page ${PAGE_NUM} diff](${DIFF_URL})\n\n"
                  PAGE_DETAILS+="</details>\n"
                fi
              elif [ "$i" -lt "$PR_COUNT" ]; then
                ADDED=$((ADDED + 1))
                PAGE_DETAILS+="- Page ${PAGE_NUM} — **new**\n"
              else
                REMOVED=$((REMOVED + 1))
                PAGE_DETAILS+="- Page ${PAGE_NUM} — **removed**\n"
              fi
            done

            # Build summary line
            PARTS=()
            [ "$CHANGED" -gt 0 ]   && PARTS+=("${CHANGED} changed")
            [ "$UNCHANGED" -gt 0 ] && PARTS+=("${UNCHANGED} unchanged")
            [ "$ADDED" -gt 0 ]     && PARTS+=("${ADDED} added")
            [ "$REMOVED" -gt 0 ]   && PARTS+=("${REMOVED} removed")
            SUMMARY="${PR_COUNT} pages total: $(IFS=', '; echo "${PARTS[*]}")"
            [ "$BASE_COUNT" -ne "$PR_COUNT" ] && SUMMARY+=" (was ${BASE_COUNT})"

            {
              echo ""
              echo "#### Diff vs main"
              echo "${SUMMARY}"
              echo ""
              printf '%b' "$PAGE_DETAILS"
            } >> pr-comment.md
          fi

          # Set multiline output for the comment step
          {
            echo 'body<<ENDOFCOMMENT'
            cat pr-comment.md
            echo 'ENDOFCOMMENT'
          } >> "$GITHUB_OUTPUT"

      - name: Push PDF and diffs to PR preview branch
        if: github.event_name == 'pull_request'
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          HEAD_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          BRANCH="gh-pages-pr-${PR_NUMBER}"
          git checkout --orphan "$BRANCH"
          git rm -rf --cached .
          git add -f main.pdf
          # Add diff images if any were generated
          for f in diff-pages/diff-page-*.png; do
            [ -f "$f" ] || continue
            NAME=$(basename "$f")
            mv "$f" "$NAME"
            git add -f "$NAME"
          done
          git commit -m "PDF preview for PR #${PR_NUMBER} (${HEAD_SHA:0:7})"
          git push -f origin "$BRANCH"

      - name: Comment on PR with PDF link and diff
        if: github.event_name == 'pull_request'
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body: ${{ steps.diff.outputs.body }}
          edit-mode: replace

  deploy:
    if: github.ref == 'refs/heads/main'
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    permissions:
      pages: write
      id-token: write
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
